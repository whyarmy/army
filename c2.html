<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <p class="mt-4 text-gray-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">
            ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        </h1>

        <!-- Data Source Section -->
        <div class="flex items-center justify-center mb-6">
            <button id="load-data-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg cursor-pointer hover:bg-blue-600 transition-colors duration-300 shadow-md">
                ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
            </button>
        </div>

        <!-- Cards Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
            <div class="bg-blue-100 rounded-lg p-6 flex items-center shadow-md">
                <div class="text-4xl text-blue-600 mr-4">üßë‚Äçü§ù‚Äçüßë</div>
                <div>
                    <p class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="total-users" class="text-blue-800 text-3xl font-bold">-</p>
                </div>
            </div>
            <div class="bg-green-100 rounded-lg p-6 flex items-center shadow-md">
                <div class="text-4xl text-green-600 mr-4">‚≠ê</div>
                <div>
                    <p class="text-gray-500 text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <p id="avg-satisfaction" class="text-green-800 text-3xl font-bold">-</p>
                </div>
            </div>
        </div>

        <!-- Chart and Table Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Bar Chart Section -->
            <div class="bg-gray-50 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°</h2>
                <canvas id="platform-chart"></canvas>
            </div>

            <!-- Filterable Table Section -->
            <div class="bg-gray-50 rounded-lg p-6 shadow-md overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="mb-4">
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á..."
                           class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                        <tr>
                            <th scope="col" class="py-3 px-2 sm:px-4">ID</th>
                            <th scope="col" class="py-3 px-2 sm:px-4">‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th scope="col" class="py-3 px-2 sm:px-4">‡πÄ‡∏û‡∏®</th>
                            <th scope="col" class="py-3 px-2 sm:px-4">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
                            <th scope="col" class="py-3 px-2 sm:px-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                            <th scope="col" class="py-3 px-2 sm:px-4">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables for Chart.js instance and data
        let myChart;
        let customerData = [];
        
        // URL of the Google Sheets CSV export
        const googleSheetsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT4JnLY0VSxqcEhvYzqosJAugJuz4NA1HDA9Ssd0gImetvspl7J4HsDqxqvv80U4iGRTuRyZABiCQ1y/pub?gid=0&single=true&output=csv';

        // Function to parse CSV content and update the dashboard
        function updateDashboard(csvContent) {
            const lines = csvContent.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            customerData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    customerData.push(row);
                }
            }

            // Update cards
            const totalUsers = customerData.length;
            const satisfactionScores = customerData.map(item => parseFloat(item.satisfaction_score));
            const avgSatisfaction = (satisfactionScores.reduce((sum, score) => sum + score, 0) / totalUsers).toFixed(2);
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('avg-satisfaction').textContent = avgSatisfaction;

            // Update chart
            if (myChart) {
                myChart.destroy();
            }
            const platformCounts = {};
            customerData.forEach(item => {
                const platform = item.preferred_platform;
                platformCounts[platform] = (platformCounts[platform] || 0) + 1;
            });
            const chartData = {
                labels: Object.keys(platformCounts),
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                    data: Object.values(platformCounts),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            };
            myChart = new Chart(document.getElementById('platform-chart'), config);
            
            // Render table
            renderTable(customerData);
        }

        // Function to render table rows
        function renderTable(dataToRender) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = ''; // Clear table
            dataToRender.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-2 sm:px-4">${item.customer_id}</td>
                    <td class="py-3 px-2 sm:px-4">${item.age}</td>
                    <td class="py-3 px-2 sm:px-4">${item.gender}</td>
                    <td class="py-3 px-2 sm:px-4">${item.preferred_platform}</td>
                    <td class="py-3 px-2 sm:px-4">${item.satisfaction_score}</td>
                    <td class="py-3 px-2 sm:px-4">${item.location}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Function to fetch data from the URL
        async function fetchAndRenderData() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(googleSheetsUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvContent = await response.text();
                updateDashboard(csvContent);
            } catch (error) {
                console.error('Error fetching data:', error);
                // Simple feedback to the user via the loading message
                document.querySelector('#loading-overlay p').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loadButton = document.getElementById('load-data-btn');
            const searchInput = document.getElementById('search-input');

            // Initial data load on page load
            fetchAndRenderData();

            // Event listener for the load button
            loadButton.addEventListener('click', fetchAndRenderData);

            // Event listener for search input
            searchInput.addEventListener('keyup', (e) => {
                const query = e.target.value.toLowerCase();
                const filteredData = customerData.filter(item => {
                    return Object.values(item).some(value => 
                        String(value).toLowerCase().includes(query)
                    );
                });
                renderTable(filteredData);
            });
        });
    </script>
</body>
</html>
